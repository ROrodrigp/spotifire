{% extends "base.html" %}

{% block title %}Spotifire - Tu Perfil Musical{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
/* Estilos espec√≠ficos para los nuevos insights */
.insight-card {
    background: linear-gradient(145deg, #282828, #1a1a1a);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(29, 185, 84, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.insight-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(29, 185, 84, 0.15);
}

.insight-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #1DB954;
}

.insight-icon {
    font-size: 24px;
    color: #1DB954;
    margin-right: 12px;
    width: 30px;
    text-align: center;
}

.insight-title {
    font-size: 18px;
    font-weight: bold;
    color: #ffffff;
    margin: 0;
    flex-grow: 1;
}

.insight-period {
    font-size: 12px;
    color: #b3b3b3;
    background: rgba(29, 185, 84, 0.1);
    padding: 4px 8px;
    border-radius: 4px;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 15px 0;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.chart-container.small {
    height: 200px;
}

.chart-container.medium {
    height: 250px;
}

.metric-summary {
    display: flex;
    justify-content: space-around;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #333;
}

.metric-item {
    text-align: center;
    flex: 1;
}

.metric-value {
    font-size: 24px;
    font-weight: bold;
    color: #1DB954;
    display: block;
}

.metric-label {
    font-size: 12px;
    color: #b3b3b3;
    margin-top: 4px;
}

.loading-placeholder {
    text-align: center;
    padding: 40px 20px;
    color: #b3b3b3;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #333;
    border-radius: 50%;
    border-top-color: #1DB954;
    animation: spin 1s ease-in-out infinite;
    margin-right: 10px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.error-state {
    text-align: center;
    padding: 20px;
    color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
    border-radius: 8px;
    margin: 10px 0;
}

.no-data-state {
    text-align: center;
    padding: 30px 20px;
    color: #b3b3b3;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    margin: 10px 0;
}

.no-data-icon {
    font-size: 48px;
    color: #333;
    margin-bottom: 15px;
}

.profile-badge {
    display: inline-block;
    background: linear-gradient(45deg, #1DB954, #1ed760);
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: bold;
    margin-top: 10px;
}

.comparison-bars {
    display: flex;
    align-items: center;
    margin: 10px 0;
}

.bar-container {
    flex: 1;
    margin: 0 10px;
}

.bar-label {
    font-size: 14px;
    color: #ffffff;
    margin-bottom: 5px;
    text-align: center;
}

.progress-bar {
    height: 8px;
    background: #333;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #1DB954, #1ed760);
    border-radius: 4px;
    transition: width 1s ease-out;
}

.insight-description {
    font-size: 14px;
    color: #b3b3b3;
    line-height: 1.4;
    margin-top: 10px;
    font-style: italic;
}

/* Responsive design */
@media (max-width: 768px) {
    .insight-card {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .metric-summary {
        flex-direction: column;
        gap: 10px;
    }
    
    .comparison-bars {
        flex-direction: column;
        gap: 15px;
    }
}
</style>
{% endblock %}

{% block navigation %}
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="bi bi-music-note-beamed"></i> Spotifire
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <span class="navbar-text me-3">
                        <i class="bi bi-person-circle"></i> {{ user_name }}
                    </span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout">
                        <i class="bi bi-box-arrow-right"></i> Cerrar sesi√≥n
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>
{% endblock %}

{% block container_fluid %}-fluid{% endblock %}

{% block content %}
<div class="row">
    <!-- Sidebar -->
    <div class="col-lg-2 sidebar d-none d-lg-block">
        <a href="#" class="sidebar-item active">
            <i class="bi bi-house-door sidebar-icon"></i> Inicio
        </a>
        <a href="#recent-tracks-section" class="sidebar-item">
            <i class="bi bi-music-note-list sidebar-icon"></i> Actividad Reciente
        </a>
        <a href="#music-profile-section" class="sidebar-item">
            <i class="bi bi-robot sidebar-icon"></i> Perfil Musical IA
        </a>
        <a href="#top-artists-section" class="sidebar-item">
            <i class="bi bi-person-badge sidebar-icon"></i> Artistas Favoritos
        </a>
        <a href="#daily-pattern-section" class="sidebar-item">
            <i class="bi bi-clock sidebar-icon"></i> Ritmo Diario
        </a>
        <a href="#weekly-pattern-section" class="sidebar-item">
            <i class="bi bi-calendar-week sidebar-icon"></i> Patrones Semanales
        </a>
        <a href="#popularity-section" class="sidebar-item">
            <i class="bi bi-graph-up sidebar-icon"></i> An√°lisis Musical
        </a>
    </div>
    
    <!-- Content area -->
    <div class="col-lg-10 content-area">
        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <div>
                <h3 class="welcome-message">¬°Hola, {{ user_name }}!</h3>
                <p class="mb-0" style="color: rgba(255,255,255,0.8);">
                    {% if insights_available and advanced_insights.top_artists %}
                        Tu estado musical de esta semana
                    {% else %}
                        ¬°Bienvenido a tu nuevo dashboard musical!
                    {% endif %}
                </p>
            </div>
            <button class="btn btn-dark" onclick="refreshAllInsights()">
                <i class="bi bi-arrow-clockwise"></i> Actualizar datos
            </button>
            {% if user_music_profile %}
            <button class="btn btn-outline-light ms-2" onclick="refreshMusicProfile()">
                <i class="bi bi-person-badge"></i> Actualizar perfil
            </button>
            {% endif %}
        </div>

        <!-- Secci√≥n de Actividad Reciente (datos en tiempo real) - MOVIDO ARRIBA -->
        <div class="row" id="recent-tracks-section">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-music-note-list me-2"></i> Actividad Musical Reciente
                    </div>
                    <div class="card-body">
                        {% if recent_tracks %}
                            {% for track in recent_tracks %}
                                <div class="track-item">
                                    <div class="track-details">
                                        <div class="track-title">{{ track.name }}</div>
                                        <div class="track-artist">{{ track.artist }}</div>
                                    </div>
                                    <div class="track-time">
                                        {% if track.played_at %}
                                            {{ track.played_at }}
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-data-state">
                                <p>No se encontraron canciones recientes.</p>
                                <small>¬°Empieza a escuchar m√∫sica en Spotify!</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-person-badge me-2"></i> Artistas del Momento
                    </div>
                    <div class="card-body">
                        {% if top_artists %}
                            {% for artist in top_artists %}
                                <div class="artist-item">
                                    <div class="artist-details">
                                        <div class="artist-name">{{ artist.name }}</div>
                                        <div class="artist-genre">
                                            {% if artist.genres and artist.genres|length > 0 %}
                                                {{ artist.genres|join(', ') }}
                                            {% else %}
                                                Sin g√©neros definidos
                                            {% endif %}
                                        </div>
                                        <div class="popularity-bar popularity-{{ (artist.popularity//10)*10 if artist.popularity is defined else 50 }}"></div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="no-data-state">
                                <p>No se encontraron artistas destacados.</p>
                                <small>¬°Escucha m√°s m√∫sica para descubrir tus artistas favoritos!</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Perfil Musical (ML Clustering) -->
        {% if user_music_profile %}
        <div class="row" id="music-profile-section">
            <div class="col-12">
                <div class="insight-card" style="background: linear-gradient(135deg, #1DB954, #1ed760); color: white;">
                    <div class="insight-header" style="border-bottom: 2px solid rgba(255,255,255,0.3);">
                        <span class="insight-icon" style="font-size: 32px;">{{ user_music_profile.emoji }}</span>
                        <h4 class="insight-title">Tu Perfil Musical: {{ user_music_profile.name }}</h4>
                        <span class="insight-period" style="background: rgba(255,255,255,0.2);">ML Clustering</span>
                    </div>
                    
                    <div style="padding: 15px 0;">
                        <p style="font-size: 16px; margin-bottom: 15px; line-height: 1.5;">
                            {{ user_music_profile.description }}
                        </p>
                        
                        <div class="metric-summary" style="border-top: 1px solid rgba(255,255,255,0.3);">
                            <div class="metric-item">
                                <span class="metric-value" style="color: white;">{{ user_music_profile.stats.percentage if user_music_profile.stats else 0 }}%</span>
                                <div class="metric-label" style="color: rgba(255,255,255,0.8);">de usuarios</div>
                            </div>
                            <div class="metric-item">
                                <span class="metric-value" style="color: white;">{{ user_music_profile.cluster + 1 }}</span>
                                <div class="metric-label" style="color: rgba(255,255,255,0.8);">Cluster ID</div>
                            </div>
                            <div class="metric-item">
                                <span class="metric-value" style="color: white;">üéØ</span>
                                <div class="metric-label" style="color: rgba(255,255,255,0.8);">Perfil √∫nico</div>
                            </div>
                        </div>
                        
                        {% if user_music_profile.characteristics %}
                        <div class="insight-description" style="color: rgba(255,255,255,0.9); margin-top: 15px;">
                            <small><strong>Caracter√≠sticas:</strong> {{ user_music_profile.characteristics }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if insights_available and advanced_insights %}
        
        <!-- Insights Principales - MOVIDOS ABAJO -->
        <div class="row">
            <!-- Artistas M√°s Escuchados -->
            <div class="col-xl-6 col-lg-12" id="top-artists-section">
                <div class="insight-card">
                    <div class="insight-header">
                        <i class="bi bi-star-fill insight-icon"></i>
                        <h4 class="insight-title">Tus Artistas Favoritos</h4>
                        <span class="insight-period">√∫ltima semana</span>
                    </div>
                    
                    <div id="top-artists-content">
                        {% if advanced_insights.top_artists and advanced_insights.top_artists|length > 0 %}
                            <div class="chart-container medium">
                                <canvas id="topArtistsChart"></canvas>
                            </div>
                            
                            <div class="metric-summary">
                                <div class="metric-item">
                                    <span class="metric-value">{{ advanced_insights.top_artists|length }}</span>
                                    <div class="metric-label">Artistas Top</div>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">{{ advanced_insights.top_artists[0].play_count }}</span>
                                    <div class="metric-label">M√°s Escuchado</div>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">{{ (advanced_insights.top_artists | sum(attribute='play_count')) }}</span>
                                    <div class="metric-label">Total Reproducciones</div>
                                </div>
                            </div>
                            
                            <div class="insight-description">
                                Tu artista m√°s escuchado es <strong>{{ advanced_insights.top_artists[0].artist_name }}</strong> 
                                con {{ advanced_insights.top_artists[0].play_count }} reproducciones.
                            </div>
                        {% else %}
                            <div class="no-data-state">
                                <div class="no-data-icon">üéµ</div>
                                <h5>¬°Empieza a escuchar m√∫sica!</h5>
                                <p>Una vez que tengas m√°s reproducciones, aqu√≠ ver√°s tus artistas favoritos.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Ritmo Musical Diario -->
            <div class="col-xl-6 col-lg-12" id="daily-pattern-section">
                <div class="insight-card">
                    <div class="insight-header">
                        <i class="bi bi-clock insight-icon"></i>
                        <h4 class="insight-title">Tu Ritmo Musical</h4>
                        <span class="insight-period">patr√≥n por hora</span>
                    </div>
                    
                    <div id="daily-pattern-content">
                        {% if advanced_insights.daily_pattern and (advanced_insights.daily_pattern | sum(attribute='play_count')) > 0 %}
                            <div class="chart-container medium">
                                <canvas id="dailyPatternChart"></canvas>
                            </div>
                            
                            {% set peak_hour = advanced_insights.daily_pattern | max(attribute='play_count') %}
                            {% set total_plays = advanced_insights.daily_pattern | sum(attribute='play_count') %}
                            
                            <div class="metric-summary">
                                <div class="metric-item">
                                    <span class="metric-value">{{ peak_hour.hour_label if peak_hour and peak_hour.play_count > 0 else "--" }}</span>
                                    <div class="metric-label">Hora Pico</div>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">{{ peak_hour.play_count if peak_hour else 0 }}</span>
                                    <div class="metric-label">Max Reproducciones</div>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">{{ "%.1f"|format(total_plays/24) if total_plays > 0 else "0.0" }}</span>
                                    <div class="metric-label">Promedio/Hora</div>
                                </div>
                            </div>
                            
                            {% if peak_hour and peak_hour.play_count > 0 %}
                            <div class="insight-description">
                                Tu momento m√°s musical del d√≠a es a las <strong>{{ peak_hour.hour_label }}</strong>.
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="no-data-state">
                                <div class="no-data-icon">‚è∞</div>
                                <h5>Descubre tu horario musical</h5>
                                <p>Con m√°s reproducciones podremos identificar tus horarios favoritos para escuchar m√∫sica.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Patrones de Semana vs Fin de Semana -->
            <div class="col-xl-6 col-lg-12" id="weekly-pattern-section">
                <div class="insight-card">
                    <div class="insight-header">
                        <i class="bi bi-calendar-week insight-icon"></i>
                        <h4 class="insight-title">Semana vs Fin de Semana</h4>
                        <span class="insight-period">√∫ltimos 7 d√≠as</span>
                    </div>
                    
                    <div id="weekly-pattern-content">
                        {% if advanced_insights.weekly_pattern and advanced_insights.weekly_pattern.weekday and advanced_insights.weekly_pattern.weekend %}
                            {% set weekday_data = advanced_insights.weekly_pattern.weekday %}
                            {% set weekend_data = advanced_insights.weekly_pattern.weekend %}
                            {% set total_pattern_plays = weekday_data.play_count + weekend_data.play_count %}
                            
                            {% if total_pattern_plays > 0 %}
                                <div class="comparison-bars">
                                    <div class="bar-container">
                                        <div class="bar-label">D√≠as Laborales</div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {{ weekday_data.percentage|default(0) }}%"></div>
                                        </div>
                                        <div style="text-align: center; margin-top: 5px; color: #1DB954; font-weight: bold;">
                                            {{ weekday_data.percentage|default(0) }}%
                                        </div>
                                    </div>
                                    
                                    <div class="bar-container">
                                        <div class="bar-label">Fin de Semana</div>
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: {{ weekend_data.percentage|default(0) }}%"></div>
                                        </div>
                                        <div style="text-align: center; margin-top: 5px; color: #1DB954; font-weight: bold;">
                                            {{ weekend_data.percentage|default(0) }}%
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="metric-summary">
                                    <div class="metric-item">
                                        <span class="metric-value">{{ weekday_data.play_count|default(0) }}</span>
                                        <div class="metric-label">Reproducciones L-V</div>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-value">{{ weekend_data.play_count|default(0) }}</span>
                                        <div class="metric-label">Reproducciones S-D</div>
                                    </div>
                                    <div class="metric-item">
                                        <span class="metric-value">
                                            {{ "%.1f"|format((weekday_data.avg_popularity|default(0) + weekend_data.avg_popularity|default(0)) / 2) }}
                                        </span>
                                        <div class="metric-label">Popularidad Promedio</div>
                                    </div>
                                </div>
                                
                                <div class="insight-description">
                                    {% if weekday_data.percentage|default(0) > weekend_data.percentage|default(0) %}
                                        Escuchas m√°s m√∫sica durante la <strong>semana laboral</strong> ({{ weekday_data.percentage|default(0) }}%).
                                    {% elif weekend_data.percentage|default(0) > weekday_data.percentage|default(0) %}
                                        Prefieres disfrutar tu m√∫sica en el <strong>fin de semana</strong> ({{ weekend_data.percentage|default(0) }}%).
                                    {% else %}
                                        Tienes un patr√≥n equilibrado entre semana y fin de semana.
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="no-data-state">
                                    <div class="no-data-icon">üìÖ</div>
                                    <h5>Patrones por descubrir</h5>
                                    <p>Con m√°s reproducciones podremos analizar si prefieres escuchar m√∫sica en d√≠as laborales o fines de semana.</p>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="no-data-state">
                                <div class="no-data-icon">üìÖ</div>
                                <h5>Patrones por descubrir</h5>
                                <p>Con m√°s reproducciones podremos analizar si prefieres escuchar m√∫sica en d√≠as laborales o fines de semana.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Artistas Emergentes vs Establecidos -->
            <div class="col-xl-6 col-lg-12" id="popularity-section">
                <div class="insight-card">
                    <div class="insight-header">
                        <i class="bi bi-graph-up insight-icon"></i>
                        <h4 class="insight-title">Tu An√°lisis Musical</h4>
                        <span class="insight-period">emergentes vs establecidos</span>
                    </div>
                    
                    <div id="popularity-content">
                        {% if advanced_insights.popularity_distribution and advanced_insights.popularity_distribution.summary and advanced_insights.popularity_distribution.summary.total_plays > 0 %}
                            <div class="chart-container small">
                                <canvas id="popularityChart"></canvas>
                            </div>
                            
                            {% set pop_data = advanced_insights.popularity_distribution %}
                            
                            <div class="metric-summary">
                                <div class="metric-item">
                                    <span class="metric-value">{{ pop_data.emergent.percentage|default(0) }}%</span>
                                    <div class="metric-label">Emergentes</div>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">{{ pop_data.growing.percentage|default(0) }}%</span>
                                    <div class="metric-label">En Crecimiento</div>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-value">{{ pop_data.established.percentage|default(0) }}%</span>
                                    <div class="metric-label">Establecidos</div>
                                </div>
                            </div>
                            
                            {% if pop_data.summary and pop_data.summary.dominant_tier %}
                                {% set dominant_tier = pop_data.summary.dominant_tier %}
                                {% if dominant_tier == 'emergent' %}
                                    <div class="profile-badge">üîç Descubridor Underground</div>
                                    <div class="insight-description">
                                        Eres un <strong>explorador musical</strong>. Te gusta descubrir artistas antes de que se vuelvan populares.
                                    </div>
                                {% elif dominant_tier == 'growing' %}
                                    <div class="profile-badge">‚öñÔ∏è Explorador Equilibrado</div>
                                    <div class="insight-description">
                                        Tienes un <strong>gusto musical equilibrado</strong>, mezclando artistas emergentes con establecidos.
                                    </div>
                                {% elif dominant_tier == 'established' %}
                                    <div class="profile-badge">‚≠ê Amante del Mainstream</div>
                                    <div class="insight-description">
                                        Disfrutas de la <strong>m√∫sica popular</strong> y los √©xitos que conectan con las masas.
                                    </div>
                                {% else %}
                                    <div class="profile-badge">üéµ Explorador Musical</div>
                                    <div class="insight-description">
                                        Tu perfil musical est√° por definirse. ¬°Sigue escuchando m√∫sica!
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            <div class="no-data-state">
                                <div class="no-data-icon">üéØ</div>
                                <h5>Definiendo tu perfil</h5>
                                <p>Con m√°s reproducciones podremos identificar si prefieres artistas emergentes o establecidos.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        
        <!-- Fallback: Mostrar mensaje de insights no disponibles -->
        <div class="row">
            <div class="col-12">
                <div class="insight-card">
                    <div class="no-data-state">
                        <div class="no-data-icon">üìä</div>
                        <h5>¬°Bienvenido a Spotifire!</h5>
                        <p>Tus insights musicales estar√°n disponibles una vez que tengamos suficientes datos de tu historial de reproducci√≥n.</p>
                        <p><small>Esto puede tomar unas horas despu√©s de conectar tu cuenta por primera vez.</small></p>
                        <p><small>¬°Sigue escuchando m√∫sica y regresa pronto para ver tus estad√≠sticas personalizadas!</small></p>
                    </div>
                </div>
            </div>
        </div>
        
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
<script>
// Variables globales para los gr√°ficos
let topArtistsChart = null;
let dailyPatternChart = null;
let popularityChart = null;

// Datos del template para JavaScript con validaci√≥n
const insightsData = {
    topArtists: {{ advanced_insights.top_artists | tojson if advanced_insights and advanced_insights.top_artists else '[]' }},
    dailyPattern: {{ advanced_insights.daily_pattern | tojson if advanced_insights and advanced_insights.daily_pattern else '[]' }},
    popularityDistribution: {{ advanced_insights.popularity_distribution | tojson if advanced_insights and advanced_insights.popularity_distribution else '{}' }}
};

// Verificar si hay datos v√°lidos
const hasValidData = {
    topArtists: insightsData.topArtists && insightsData.topArtists.length > 0,
    dailyPattern: insightsData.dailyPattern && insightsData.dailyPattern.length > 0 && 
                  insightsData.dailyPattern.some(item => item.play_count > 0),
    popularityDistribution: insightsData.popularityDistribution && 
                           insightsData.popularityDistribution.summary && 
                           insightsData.popularityDistribution.summary.total_plays > 0
};

// Inicializar gr√°ficos cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    console.log('Has valid data:', hasValidData);
    
    // Wait a bit for Chart.js to fully load
    setTimeout(() => {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        } else {
            console.error('Chart.js no est√° disponible');
        }
    }, 1000);
    
    setupSidebarNavigation();
});

function initializeCharts() {
    console.log('Initializing charts...');
    
    // Gr√°fico de Artistas Top
    if (hasValidData.topArtists) {
        console.log('Creating top artists chart');
        createTopArtistsChart();
    } else {
        console.log('No top artists data available');
    }
    
    // Gr√°fico de Patr√≥n Diario
    if (hasValidData.dailyPattern) {
        console.log('Creating daily pattern chart');
        createDailyPatternChart();
    } else {
        console.log('No daily pattern data available');
    }
    
    // Gr√°fico de Distribuci√≥n de Popularidad
    if (hasValidData.popularityDistribution) {
        console.log('Creating popularity chart');
        createPopularityChart();
    } else {
        console.log('No popularity distribution data available');
    }
}

function createTopArtistsChart() {
    const ctx = document.getElementById('topArtistsChart');
    if (!ctx) {
        console.error('Canvas topArtistsChart not found');
        return;
    }
    
    const artists = insightsData.topArtists.slice(0, 8); // Top 8 para mejor visualizaci√≥n
    
    try {
        topArtistsChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: artists.map(artist => artist.artist_name.length > 15 ? 
                    artist.artist_name.substring(0, 15) + '...' : artist.artist_name),
                datasets: [{
                    label: 'Reproducciones',
                    data: artists.map(artist => artist.play_count),
                    backgroundColor: 'rgba(29, 185, 84, 0.8)',
                    borderColor: 'rgba(29, 185, 84, 1)',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#1DB954',
                        bodyColor: '#ffffff',
                        borderColor: '#1DB954',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#b3b3b3'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#b3b3b3',
                            maxRotation: 45
                        },
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        console.log('Top artists chart created successfully');
    } catch (error) {
        console.error('Error creating top artists chart:', error);
    }
}

function createDailyPatternChart() {
    const ctx = document.getElementById('dailyPatternChart');
    if (!ctx) {
        console.error('Canvas dailyPatternChart not found');
        return;
    }
    
    const hourlyData = insightsData.dailyPattern;
    
    try {
        dailyPatternChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: hourlyData.map(item => item.hour_label),
                datasets: [{
                    label: 'Reproducciones por Hora',
                    data: hourlyData.map(item => item.play_count),
                    borderColor: '#1DB954',
                    backgroundColor: 'rgba(29, 185, 84, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#1DB954',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#1DB954',
                        bodyColor: '#ffffff',
                        borderColor: '#1DB954',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: '#b3b3b3'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: '#b3b3b3',
                            callback: function(value, index) {
                                // Mostrar solo cada 4 horas para evitar saturaci√≥n
                                return index % 4 === 0 ? this.getLabelForValue(value) : '';
                            }
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });
        console.log('Daily pattern chart created successfully');
    } catch (error) {
        console.error('Error creating daily pattern chart:', error);
    }
}

function createPopularityChart() {
    const ctx = document.getElementById('popularityChart');
    if (!ctx) {
        console.error('Canvas popularityChart not found');
        return;
    }
    
    const popData = insightsData.popularityDistribution;
    
    try {
        popularityChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Emergentes', 'En Crecimiento', 'Establecidos'],
                datasets: [{
                    data: [
                        popData.emergent ? popData.emergent.percentage : 0,
                        popData.growing ? popData.growing.percentage : 0,
                        popData.established ? popData.established.percentage : 0
                    ],
                    backgroundColor: [
                        'rgba(255, 107, 107, 0.8)',  // Rojo para emergentes
                        'rgba(255, 193, 7, 0.8)',    // Amarillo para en crecimiento
                        'rgba(29, 185, 84, 0.8)'     // Verde para establecidos
                    ],
                    borderColor: [
                        'rgba(255, 107, 107, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(29, 185, 84, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#ffffff',
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#1DB954',
                        bodyColor: '#ffffff',
                        borderColor: '#1DB954',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed + '%';
                            }
                        }
                    }
                }
            }
        });
        console.log('Popularity chart created successfully');
    } catch (error) {
        console.error('Error creating popularity chart:', error);
    }
}

function setupSidebarNavigation() {
    // Navegaci√≥n suave para enlaces del sidebar
    const sidebarItems = document.querySelectorAll('.sidebar-item[href^="#"]');
    sidebarItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Actualizar estado activo
                sidebarItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            }
        });
    });
}

function refreshAllInsights() {
    const btn = document.querySelector('.welcome-banner button');
    const originalText = btn.innerHTML;
    
    // Mostrar estado de carga
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Actualizando...';
    btn.disabled = true;
    
    // Llamar a la API para refrescar insights
    fetch('/api/insights/refresh')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Recargar la p√°gina para mostrar datos actualizados
                window.location.reload();
            } else {
                throw new Error(data.error || 'Error desconocido');
            }
        })
        .catch(error => {
            console.error('Error refrescando insights:', error);
            alert('Error al actualizar los datos. Por favor, int√©ntalo de nuevo.');
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

function refreshMusicProfile() {
    const btn = document.querySelector('button[onclick="refreshMusicProfile()"]');
    if (!btn) return;
    
    const originalText = btn.innerHTML;
    
    // Mostrar estado de carga
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Actualizando perfil...';
    btn.disabled = true;
    
    // Llamar a la API para refrescar perfiles
    fetch('/api/music-profiles/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Recargar la p√°gina para mostrar perfil actualizado
            window.location.reload();
        } else {
            throw new Error(data.message || 'Error desconocido');
        }
    })
    .catch(error => {
        console.error('Error refrescando perfil musical:', error);
        alert('Error al actualizar el perfil musical. Por favor, int√©ntalo de nuevo.');
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}